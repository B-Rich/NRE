From 4b1ea894e2431fe7b3c9b988e7c9fc6072d533c3 Mon Sep 17 00:00:00 2001
From: Nils Asmussen <nils@os.inf.tu-dresden.de>
Date: Thu, 19 Jul 2012 15:24:04 +0200
Subject: [PATCH 1/4] Support for the CR0.WP flag in the VTLB

---
 src/regs.cpp |    2 +-
 src/vtlb.cpp |    4 ++++
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/src/regs.cpp b/src/regs.cpp
index 714ffbe..ccbec92 100644
--- a/src/regs.cpp
+++ b/src/regs.cpp
@@ -369,7 +369,7 @@ void Exc_regs::write_cr (unsigned cr, mword val)
             toggled = get_cr0<T>() ^ val;
 
             if (!nst_on)
-                if (toggled & (Cpu::CR0_PG | Cpu::CR0_PE))
+            	if (toggled & (Cpu::CR0_PG | Cpu::CR0_PE | Cpu::CR0_WP))
                     tlb_flush<T> (true);
 
             set_cr0<T> (val);
diff --git a/src/vtlb.cpp b/src/vtlb.cpp
index c8ae5b2..9d20005 100644
--- a/src/vtlb.cpp
+++ b/src/vtlb.cpp
@@ -33,6 +33,7 @@ size_t Vtlb::walk (Exc_regs *regs, mword virt, mword &phys, mword &attr, mword &
 
     bool pse = regs->cr4_shadow & (Cpu::CR4_PSE | Cpu::CR4_PAE);
     bool pge = regs->cr4_shadow &  Cpu::CR4_PGE;
+    bool wp = regs->cr0_shadow & Cpu::CR0_WP;
 
     type &= ERR_U | ERR_W;
 
@@ -58,6 +59,9 @@ size_t Vtlb::walk (Exc_regs *regs, mword virt, mword &phys, mword &attr, mword &
             continue;
         }
 
+        if(!wp && (~type & ERR_U) && (type & ERR_W))
+            attr = (attr & ~ERR_U) | ERR_W;
+
         if (EXPECT_FALSE ((attr & type) != type)) {
             type |= ERR_P;
             return 0;
-- 
1.7.9.5

